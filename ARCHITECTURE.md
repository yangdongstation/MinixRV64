# Minix RV64 架构设计

## 系统架构概述

```
┌─────────────────────────────────────────────────────────┐
│                    用户空间进程                           │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │    Shell    │  │   Init      │  │  User App   │     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
└─────────────────────────────────────────────────────────┘
                         │ 系统调用
┌─────────────────────────────────────────────────────────┐
│                     Minix 内核                           │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │  进程管理    │  │  内存管理    │  │  文件系统    │     │
│  │ Scheduler   │  │   MMU       │  │   VFS       │     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
│                                                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │  中断处理    │  │  设备驱动    │  │  网络栈      │     │
│  │   Trap      │  │  Drivers    │  │   TCP/IP    │     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
└─────────────────────────────────────────────────────────┘
                         │ 硬件抽象层
┌─────────────────────────────────────────────────────────┐
│                  RISC-V 64位硬件                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │ CPU C906    │  │  内存控制器  │  │   外设       │     │
│  │ 1GHz RV64GC │  │  LPDDR4     │  │ UART/GPIO   │     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
└─────────────────────────────────────────────────────────┘
```

## 内存布局

```
0x00000000 ┌─────────────────────────────────────┐
           │           Boot ROM                   │
           └─────────────────────────────────────┘

0x03000000 ┌─────────────────────────────────────┐
           │         外设寄存器                   │
           │  - UART, GPIO, I2C, SPI             │
           │  - Timer, Interrupt Controller      │
           └─────────────────────────────────────┘

0x07000000 ┌─────────────────────────────────────┐
           │         其他I/O映射                  │
           └─────────────────────────────────────┘

0x80000000 ┌─────────────────────────────────────┐ ← 内核加载地址
           │          内核代码段                   │
           │         (.text)                     │
0x80100000 ├─────────────────────────────────────┤
           │          内核数据段                   │
           │   (.rodata, .data, .bss)           │
0x80200000 ├─────────────────────────────────────┤
           │          内核堆栈                     │
           └─────────────────────────────────────┘

0x80300000 ┌─────────────────────────────────────┐
           │          内核堆                      │
           └─────────────────────────────────────┘

0x81000000 ┌─────────────────────────────────────┐
           │          用户空间                     │
           │        进程1, 2, 3...               │
           └─────────────────────────────────────┘
```

## 模块详细设计

### 1. 启动流程 (boot/start.S)
- 设置CPU模式 (Machine -> Supervisor)
- 配置PMP (物理内存保护)
- 初始化BSS段
- 设置堆栈
- 跳转到C入口点

### 2. 内存管理 (mm/)
- **物理内存管理**: 伙伴算法
- **虚拟内存**: SV39页表 (39位虚拟地址)
- **内存映射**: 直接映射 + 内核空间映射
- **分配器**: slab分配器用于内核对象

### 3. 进程管理 (kernel/sched.c)
- **进程状态**: 就绪、运行、阻塞、僵尸
- **调度算法**: 抢占式优先级调度
- **上下文切换**: 保存/恢复寄存器
- **进程通信**: 消息传递机制

### 4. 设备驱动 (drivers/)
- **UART驱动**:
  - 16550兼容串口控制器
  - 发送/接收缓冲区 (256字节)
  - 中断驱动支持
  - 可配置波特率、数据位、校验位
  - 统计信息收集
- **GPIO驱动**: 通用IO控制 (待实现)
- **中断驱动**: 中断控制器管理
- **块设备**: SD/eMMC支持

### 5. 文件系统 (fs/)
- **VFS层**:
  - 统一文件接口
  - 路径解析 (支持 `.` 和 `..`)
  - 挂载点管理
  - 文件系统注册机制
- **devfs**: 设备文件系统
  - 字符设备节点
  - 块设备节点
  - 动态设备注册/注销
- **ramfs**: 内存文件系统
  - 完全在内存中的文件系统
  - 支持文件读写
  - 支持目录创建
  - 最大文件大小 1MB
- **EXT2/3/4**: 扩展文件系统 (部分实现)
- **FAT32**: FAT文件系统 (部分实现)

### 6. 系统调用 (kernel/syscalls.c)
- **POSIX兼容**: 标准系统调用接口
- **IPC机制**: Minix特有的消息传递
- **进程管理**: fork, exec, wait, exit
- **文件操作**: open, read, write, close

## 移植关键点

1. **RISC-V特有**
   - CSR寄存器操作
   - 内存模型和缓存一致性
   - 中断和异常处理

2. **CV1800B特定**
   - 时钟树配置
   - Pinmux设置
   - 外设基地址

3. **Minix特性保留**
   - 微内核架构
   - 消息驱动
   - 进程模型

## 开发里程碑

### Phase 1: 基础框架 ✓
- [x] 项目结构
- [x] 启动代码
- [x] 基础打印
- [x] 内存管理基础

### Phase 2: 内核核心 (进行中)
- [x] 调度器框架
- [x] 中断系统基础
- [x] 系统调用框架
- [x] 进程管理框架

### Phase 3: 驱动支持 ✓
- [x] UART完整驱动
  - [x] 缓冲区支持
  - [x] 中断处理
  - [x] 配置接口
  - [x] 统计功能
- [ ] GPIO支持
- [ ] SD卡驱动
- [ ] 定时器

### Phase 4: 文件系统 (进行中)
- [x] VFS层
  - [x] 基本接口
  - [x] 路径解析
  - [x] 挂载管理
- [x] devfs设备文件系统
- [x] ramfs内存文件系统
- [ ] EXT2完整实现
- [ ] FAT32完整实现

### Phase 5: 网络与应用 (待开始)
- [ ] 基本网络栈
- [ ] Shell程序增强
- [ ] 基础工具

## 编译和部署

```bash
# 编译内核
make CROSS_COMPILE=riscv64-unknown-elf-

# 生成镜像
make minix-rv64.bin

# 部署到MilkV Duo
# 通过SD卡或USB烧录
```